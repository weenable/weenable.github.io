<!DOCTYPE html>
<html lang="en-us"
  dir="ltr">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">



<link rel="icon" type="image/ico" href="https://weenable.github.io//favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://weenable.github.io//favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://weenable.github.io//favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://weenable.github.io//android-chrome-192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://weenable.github.io//apple-touch-icon.png">

<link rel="alternate" type="application/rss+xml" href="https://weenable.github.io/categories/game/index.xml" title="Ween's Blog">
<meta name="description" content=""/>



<title>
    
    Game | Ween&#39;s Blog
    
</title>

<link rel="canonical" href="https://weenable.github.io/categories/game/"/>

<meta property="og:url" content="https://weenable.github.io/categories/game/">
  <meta property="og:site_name" content="Ween&#39;s Blog">
  <meta property="og:title" content="Game">
  <meta property="og:description" content="Ween&#39;s Blog">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="website">








<link rel="stylesheet" href="/assets/combined.min.db1f6bdda2e5a4d5c9a316aa295aaeba691b0d6154397bbb6787fea95b273e6a.css" media="all">









</head>





<body class="auto">

  <div class="content">
    <header>
      

<div class="header">

    

    <h1 class="header-title">
        <a href="https://weenable.github.io/">Ween&#39;s Blog</a>
    </h1>

    <div class="flex">
        

        
        
      
        <p class="small ">
            <a href="/" >
                /home
            </a>
        </p>
        
      
        <p class="small ">
            <a href="/posts" >
                /posts
            </a>
        </p>
        
      
        <p class="small ">
            <a href="/categories" >
                /categories
            </a>
        </p>
        
        
    </div>

    

</div>

    </header>

    <main class="main">
      

<div class="list-container">

    

    <h1>Game</h1>
    

    

    
    
    
    

    

    

    
    <div class="post-line">

    
    
    
    

    <p class="line-date">2025-02-28 </p>

    <div>
        <p class="line-title">
            <a href="/posts/game/%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E5%90%8C%E6%AD%A5%E6%9C%BA%E5%88%B6/">
                网络游戏同步机制
            </a>
        </p>

        
        <p class="line-summary"> <h3 class="heading" id="网络同步">
  网络同步
  <a class="anchor" href="#%e7%bd%91%e7%bb%9c%e5%90%8c%e6%ad%a5">#</a>
</h3>
<p>网络同步 = 数据同步 + 表现同步
网络同步一般分为帧同步和状态同步</p>
<h4 class="heading" id="帧同步">
  帧同步
  <a class="anchor" href="#%e5%b8%a7%e5%90%8c%e6%ad%a5">#</a>
</h4>
<h5 class="heading" id="基本原理">
  基本原理
  <a class="anchor" href="#%e5%9f%ba%e6%9c%ac%e5%8e%9f%e7%90%86">#</a>
</h5>
<p>计算逻辑在客户端，按照一定的帧速率（逻辑帧而非渲染帧），服务端只转发</p>
<h5 class="heading" id="帧同步缺陷">
  帧同步缺陷
  <a class="anchor" href="#%e5%b8%a7%e5%90%8c%e6%ad%a5%e7%bc%ba%e9%99%b7">#</a>
</h5>
<ul>
<li>计算逻辑不在服务端，容易出现外挂</li>
<li>严格帧锁定同步网络差的客户端会影响其他玩家体验（乐观帧锁定同步）</li>
<li>不同客户端浮点数精度问题、随机值不统一</li>
</ul>
<h5 class="heading" id="乐观帧锁定">
  乐观帧锁定
  <a class="anchor" href="#%e4%b9%90%e8%a7%82%e5%b8%a7%e9%94%81%e5%ae%9a">#</a>
</h5>
<p>传统严格帧锁定算法会出现慢网影响其他人的情况，此时可以采用定时不等待的方式，服务端以固定帧率同步数据，不依赖每个玩家是否有操作</p>
<h4 class="heading" id="状态同步">
  状态同步
  <a class="anchor" href="#%e7%8a%b6%e6%80%81%e5%90%8c%e6%ad%a5">#</a>
</h4>
<h5 class="heading" id="基本原理-1">
  基本原理
  <a class="anchor" href="#%e5%9f%ba%e6%9c%ac%e5%8e%9f%e7%90%86-1">#</a>
</h5>
<p>计算逻辑在服务端，客户端只表现。状态同步一般都应用RPC调用和增量同步技术</p>
<h5 class="heading" id="状态同步缺陷">
  状态同步缺陷
  <a class="anchor" href="#%e7%8a%b6%e6%80%81%e5%90%8c%e6%ad%a5%e7%bc%ba%e9%99%b7">#</a>
</h5>
<ul>
<li>延迟过大、服务端压力大</li>
<li>状态同步做回放系统较麻烦</li>
</ul>
<h4 class="heading" id="网络协议">
  网络协议
  <a class="anchor" href="#%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae">#</a>
</h4>
<h5 class="heading" id="一些基础">
  一些基础
  <a class="anchor" href="#%e4%b8%80%e4%ba%9b%e5%9f%ba%e7%a1%80">#</a>
</h5>
<ul>
<li>TCP是流式传输没有固定内容边界，会出现拆包和沾包问题，UDP基于报文有消息边界，不存在拆包沾包问题</li>
<li>TCP默认情况下使用Nagle算法，可以优化传输减少网络里的小包数量，传输时协议栈会累积数据直到满足以下条件之一
<ul>
<li>积累的数量达到最大MSS</li>
<li>收到一个ACK</li>
</ul>
</li>
<li>TCp默认情况下使用延迟累积ACK发送机制，传输时协议栈会合并多个ACK发送，提高网络性能，直到满足一下条件之一
<ul>
<li>累积多个ACK或有数据传输时</li>
<li>ACK超时（40ms）</li>
</ul>
</li>
<li>TCP可以使用<strong>TCP_NODELAY</strong>来关闭Nagle算法</li>
</ul>
<h5 class="heading" id="网络协议方案">
  网络协议方案
  <a class="anchor" href="#%e7%bd%91%e7%bb%9c%e5%8d%8f%e8%ae%ae%e6%96%b9%e6%a1%88">#</a>
</h5>
<p>可以默认使用TCP，然后再打开使用KCP
在网络状态较好时可以使用KCP，当出现大量丢包时切换使用TCP</p>
<h3 class="heading" id="同步优化方案">
  同步优化方案
  <a class="anchor" href="#%e5%90%8c%e6%ad%a5%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88">#</a>
</h3>
<h4 class="heading" id="表现优化">
  表现优化
  <a class="anchor" href="#%e8%a1%a8%e7%8e%b0%e4%bc%98%e5%8c%96">#</a>
</h4>
<p>表现优化主要是想弱化玩家对于延迟的感受，主要分为以下一些优化技术</p>
<h5 class="heading" id="1插值优化">
  1.插值优化
  <a class="anchor" href="#1%e6%8f%92%e5%80%bc%e4%bc%98%e5%8c%96">#</a>
</h5>
<p><a href="https://zhuanlan.zhihu.com/p/631954987?utm_id=0">https://zhuanlan.zhihu.com/p/631954987?utm_id=0</a>
状态同步中，由于客户端每次收到都是其他角色的位置信息，为了避免位置突变，客户端会使用插值技术而不是跳帧</p>
<ul>
<li>内插值目的是解决客户端离散信息更新导致的突变问题，通过线性插值Lerp插入过渡数据
<ul>
<li>收到数据包时不能直接应用，必须等到下一个数据包到来才能开始插值，延迟增加</li>
<li>运动状态发生剧烈变化时，会丢失部份运动状态</li>
</ul>
</li>
</ul>
<p>











<figure class="">

    <div>
        <img loading="lazy" alt="image-2025228102431.png" src="https://pic4.zhimg.com/v2-3fea56f86c6bffa3d32ae1681fe9ad73_b.webp" >
    </div>

    
</figure>
</p> </p>
        
    </div>
</div>
    

    

    

</div>

    </main>
  </div>

  <footer>
    

    
    <p>Powered by
        <a href="https://gohugo.io/">Hugo</a>
        and
        <a href="https://github.com/tomfran/typo">tomfran/typo</a>
    </p>
    
    
    


  </footer>

  

</body>

<script src="/js/theme-switch.js"></script>
<script defer src="/js/copy-code.js"></script>
</html>
